# Audynce Spring Boot Backend

This is the central API, orchestrator, and security handler for the Audynce application.

This service is responsible for handling all user interactions, managing authentication with Spotify, orchestrating the complex flow between the AI service and the Spotify API, and ensuring the final playlist is of high quality.

-----

## Core Responsibilities

  * **Authentication:** Manages the entire Spotify OAuth2 login flow, securely encrypts and stores user tokens, and issues its own internal JWTs for stateless session management.
  * **Orchestration:** Acts as the "brain" of the operation. It receives a prompt from the frontend, sends it to the FastAPI service for analysis, gets back a search query, and then uses that query to fetch tracks from Spotify.
  * **Quality Control:** Its most important feature. This service is responsible for cleaning up the "noisy" search results from Spotify. It runs a sophisticated **Quality Filtering Engine** to remove duplicate tracks, generic "type beats," and spammy instrumentals.
  * **Database Persistence:** Connects to a PostgreSQL database to store user information (`User`), created playlists (`Playlist`), and all associated scenes (`Scene`) and tracks (`Track`).

-----

## üõ†Ô∏è Key Components & Architecture

The service is built on a standard Spring Boot 3 structure, with a clear separation of concerns.

  * **`SecurityConfig` (`/config`)**: Configures Spring Security to handle the Spotify OAuth2 login flow (`/oauth2/authorization/spotify`) and to protect all `/api/**` endpoints using JWT authentication.
  * **`OAuth2SuccessHandler` (`/security`)**: A custom handler that intercepts a successful Spotify login. It saves or updates the user in the database, encrypts their Spotify tokens (`TokenEncryptor`), and generates a short-lived internal JWT (`JwtTokenProvider`) for the frontend.
  * **`JwtAuthenticationFilter` (`/security`)**: A filter that runs on every `/api/**` request, validates the JWT from the `Authorization` header, and sets the user's authentication context.
  * **`PlaylistOrchestrationService` (`/service`)**: This is the heart of the application.
    1.  It receives the user's prompt via the `PlaylistController`.
    2.  It calls `AIServiceClient` to get the AI-generated `searchQuery`.
    3.  It calls `SpotifyService` to fetch a large "pool" of tracks using this query.
    4.  It creates a `Set` to track added song IDs, preventing duplicates.
    5.  It loops through the track pool, using its internal `isGenericTrack()` helper to filter out low-quality results (like "Instrumental (2007)" or "Lofi Beat").
    6.  It assembles the final, clean list of tracks.
    7.  It saves the `Playlist`, `Scene`, and `Track` entities to the database.
    8.  If requested, it calls `SpotifyService` again to create the playlist on the user's Spotify account.
  * **`SpotifyService` (`/service`)**: A dedicated client that handles all raw communication with the Spotify API (e.g., `searchTracks`, `createSpotifyPlaylist`, `getUserTopArtists`).
  * **`AIServiceClient` (`/service`)**: A `WebClient`-based client responsible for communicating with the external FastAPI (Python) service.

-----

## API Endpoints

All `/api/**` endpoints are protected and require a valid JWT `Bearer` token.

| Method | Endpoint | Description |
| :--- | :--- | :--- |
| **Auth** | | |
| `GET` | `/oauth2/authorization/spotify`| **Login Endpoint.** Redirects the user to the Spotify login page. |
| **Playlists** | | |
| `POST` | `/api/playlists/generate` | **The main feature.** Takes a `PlaylistGenerateRequest` (prompt, genres, options) and returns a complete `PlaylistResponse`. |
| `GET` | `/api/playlists` | Gets all playlists generated by the currently authenticated user. |
| `DELETE`| `/api/playlists/{id}` | Deletes a previously generated playlist from the database for the current user. |
| **Users** | | |
| `GET` | `/api/users/me` | Gets the profile information for the currently authenticated user. |

-----

## üöÄ Setup & Run

### 1\. Prerequisites

  * Java 17+ (JDK)
  * Maven 3+
  * A running PostgreSQL server

### 2\. Environment Configuration

This service is configured using `springboot/src/main/resources/application.yml`. You must provide the following properties:

```yaml
server:
  port: 8080

app:
  # URL of your running React app
  frontend-url: "http://localhost:5173" 
  # URL of your running FastAPI app
  fastapi:
    url: "http://localhost:8000" 
  
  # A long, random string for signing JWTs
  jwt:
    secret: "YOUR_VERY_STRONG_AND_SECRET_JWT_KEY"
  
  # Must be 32 characters (32 bytes)
  encryption:
    key: "YOUR_32_BYTE_ENCRYPTION_SECRET_KEY"

spring:
  # Database Connection
  datasource:
    url: "jdbc:postgresql://localhost:5432/audynce_db"
    username: "your_db_user"
    password: "your_db_password"
  jpa:
    hibernate:
      ddl-auto: update # Automatically creates/updates tables
    
  # Spotify OAuth2 Credentials
  security:
    oauth2:
      client:
        registration:
          spotify:
            client-id: "YOUR_SPOTIFY_CLIENT_ID"
            client-secret: "YOUR_SPOTIFY_CLIENT_SECRET"
            scope:
              - user-read-private
              - user-read-email
              - playlist-read-private
              - playlist-modify-public
              - playlist-modify-private
              - user-top-read
```

### 3\. Run the Application

Once your `application.yml` is configured and your PostgreSQL server is running:

```bash
# From the /springboot directory
mvn spring-boot:run
```

The service will start on `http://localhost:8080`.

-----

Ready for the FastAPI service README?
